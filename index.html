<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <title>MASTER 2026 — Check</title>

  <!-- Se hai già manifest, lascia questo -->
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{
      --bg:#0b0f14; --card:#111827; --muted:#9ca3af; --text:#e5e7eb;
      --line:#1f2937; --accent:#60a5fa;
      --g:#22c55e; --y:#f59e0b; --r:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    header{position:sticky;top:0;background:rgba(11,15,20,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:10}
    .wrap{max-width:980px;margin:0 auto;padding:12px 12px 18px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .title{font-weight:800;font-size:16px;letter-spacing:.2px}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    .btn{background:transparent;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn.primary{border-color:transparent;background:var(--accent);color:#06101c;font-weight:700}
    .btn.danger{border-color:transparent;background:var(--r);color:#120606;font-weight:800}
    .grid{display:grid;gap:12px}
    @media(min-width:900px){ .grid{grid-template-columns:1.25fr .75fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px}
    .card h2{margin:0 0 10px;font-size:14px;color:var(--muted);font-weight:700}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input,select,textarea{
      width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--line);
      background:#0c1320;color:var(--text);outline:none
    }
    textarea{min-height:72px;resize:vertical}
    .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .badge{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--line)}
    .green .dot{background:var(--g)}
    .yellow .dot{background:var(--y)}
    .red .dot{background:var(--r)}
    .green{border-color:rgba(34,197,94,.35)}
    .yellow{border-color:rgba(245,158,11,.35)}
    .red{border-color:rgba(239,68,68,.35)}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .muted{color:var(--muted);font-size:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{padding:12px;border:1px solid var(--line);border-radius:16px;background:#0c1320}
    .itemTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .itemTitle{font-weight:800}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);display:flex;gap:6px;align-items:center}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .thumbs img{width:90px;height:90px;object-fit:cover;border-radius:14px;border:1px solid var(--line)}
    .noteSmall{white-space:pre-wrap;color:var(--text);opacity:.9;font-size:13px;margin-top:8px}
    .warning{padding:10px 12px;border-radius:14px;border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.08);color:#fcd34d;font-size:13px}
    .ok{padding:10px 12px;border-radius:14px;border:1px solid rgba(34,197,94,.35);background:rgba(34,197,94,.08);color:#bbf7d0;font-size:13px}
    .err{padding:10px 12px;border-radius:14px;border:1px solid rgba(239,68,68,.35);background:rgba(239,68,68,.08);color:#fecaca;font-size:13px}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="title">MASTER 2026 — CHECK</div>
        <div class="pill" id="pillMacro">Macrociclo: 1</div>
        <div class="pill" id="pillToday"></div>
      </div>
      <div class="row">
        <button class="btn" id="btnExport">Export</button>
        <button class="btn" id="btnImport">Import</button>
        <button class="btn danger" id="btnReset" title="Cancella SOLO i check (non consigliato)">Reset</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- SINISTRA: CHECK -->
    <section class="card">
      <h2>1) CHECK SETTIMANALE</h2>

      <div class="split">
        <div>
          <label>Data (id = data)</label>
          <input id="wDate" type="date" />
        </div>
        <div>
          <label>Macrociclo</label>
          <select id="wMacro">
            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
          </select>
        </div>
      </div>

      <div class="split">
        <div>
          <label>Peso (kg)</label>
          <input id="wWeight" type="number" step="0.1" inputmode="decimal" placeholder="es. 81.0" />
        </div>
        <div>
          <label>Glicemia digiuno (mg/dL) — 1 valore</label>
          <input id="wGly" type="number" step="1" inputmode="numeric" placeholder="es. 89" />
        </div>
      </div>

      <div class="split">
        <div>
          <label>Energia (1–10)</label>
          <input id="wEnergy" type="number" min="1" max="10" step="1" inputmode="numeric" placeholder="es. 6" />
        </div>
        <div>
          <label>Neuropatia</label>
          <select id="wNeuro">
            <option value="=" selected>=</option>
            <option value="↓">↓</option>
            <option value="↑">↑</option>
          </select>
        </div>
      </div>

      <div class="card" style="margin-top:12px;background:#0c1320">
        <h2>Misure corpo (cm)</h2>
        <div class="split">
          <div>
            <label>Vita (obbligatoria)</label>
            <input id="mWaist" type="number" step="0.1" inputmode="decimal" placeholder="es. 86" />
          </div>
          <div>
            <label>Fianchi (opzionale)</label>
            <input id="mHip" type="number" step="0.1" inputmode="decimal" placeholder="es. 94" />
          </div>
        </div>
        <div class="split">
          <div>
            <label>Petto (opzionale)</label>
            <input id="mChest" type="number" step="0.1" inputmode="decimal" placeholder="es. 108" />
          </div>
          <div>
            <label>Braccio (opzionale)</label>
            <input id="mArm" type="number" step="0.1" inputmode="decimal" placeholder="es. 35" />
          </div>
        </div>
        <div class="split">
          <div>
            <label>Coscia (opzionale)</label>
            <input id="mThigh" type="number" step="0.1" inputmode="decimal" placeholder="es. 54" />
          </div>
          <div>
            <label class="muted">Nota</label>
            <div class="muted">Le misure opzionali servono per trend, la vita è la chiave.</div>
          </div>
        </div>
      </div>

      <label>Nota (max 240)</label>
      <textarea id="wNote" maxlength="240" placeholder="max 240 caratteri…"></textarea>

      <div class="badges" id="badges">
        <div class="badge" id="bWeight"><span class="dot"></span><span>Peso</span></div>
        <div class="badge" id="bGly"><span class="dot"></span><span>Glicemia</span></div>
        <div class="badge" id="bEnergy"><span class="dot"></span><span>Energia</span></div>
        <div class="badge" id="bWaist"><span class="dot"></span><span>Vita</span></div>
        <div class="badge" id="bNeuro"><span class="dot"></span><span>Neuropatia</span></div>
        <div class="badge" id="bGlobal"><span class="dot"></span><span>Stato</span></div>
      </div>

      <label>Frase finale (solo consentite)</label>
      <select id="wPhrase"></select>

      <div class="row" style="margin-top:12px;justify-content:space-between">
        <button class="btn" id="btnFillDemo" title="Compila demo">Demo</button>
        <div class="row">
          <button class="btn" id="btnUpdateWeekly">Aggiorna (se esiste stessa data)</button>
          <button class="btn primary" id="btnSaveWeekly">Salva Check Settimanale</button>
        </div>
      </div>

      <div class="hr"></div>

      <h2>3) CHECK MENSILE (foto SOLO qui)</h2>
      <div class="warning">
        Il mensile NON reinserisce numeri: legge gli ultimi 4 settimanali. Tu aggiungi nota + frase + foto (se vuoi).
      </div>

      <div class="split" style="margin-top:10px">
        <div>
          <label>Data check mensile</label>
          <input id="mDate" type="date" />
        </div>
        <div>
          <label>Macrociclo</label>
          <select id="mMacro">
            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
          </select>
        </div>
      </div>

      <label>Nota mensile (max 240)</label>
      <textarea id="mNote" maxlength="240" placeholder="Riepilogo breve…"></textarea>

      <label>Frase finale mensile</label>
      <select id="mPhrase"></select>

      <label>Foto (opzionali) — consigliate 2–3 (front / side / back)</label>
      <input id="mPhotos" type="file" accept="image/*" multiple />

      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button class="btn primary" id="btnSaveMonthly">Crea e Salva Check Mensile</button>
      </div>

      <div id="msg" style="margin-top:12px"></div>
    </section>

    <!-- DESTRA: STORICO -->
    <section class="card">
      <h2>2) STORICO CHECK</h2>

      <div class="split">
        <div>
          <label>Filtro</label>
          <select id="filterType">
            <option value="all">Tutti</option>
            <option value="settimanale">Solo settimanali</option>
            <option value="mensile">Solo mensili</option>
          </select>
        </div>
        <div>
          <label>Macrociclo</label>
          <select id="filterMacro">
            <option value="all">Tutti</option>
            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;justify-content:space-between">
        <div class="muted" id="stats"></div>
        <button class="btn" id="btnRefresh">Aggiorna lista</button>
      </div>

      <div class="hr"></div>

      <div class="list" id="list"></div>
    </section>

  </div>
</div>

<script>
/* ============================
   MASTER 2026 — CHECK ENGINE
   Storage: localStorage["MASTER2026_CHECKS"]
   ============================ */

const STORAGE_KEY = "MASTER2026_CHECKS";

const WEEKLY_PHRASES = {
  green: [
    "Tutto stabile → continuo senza modifiche",
    "Trend positivo → proseguo come pianificato"
  ],
  yellow: [
    "Segnali di affaticamento → monitoro per 7 giorni",
    "Oscillazioni leggere → nessuna modifica, osservo il trend"
  ],
  red: {
    neuro: "Neuropatia in aumento → riduco volume, obiettivo invariato",
    gly: "Glicemia instabile → stop progressioni, priorità controllo",
    energy: "Energia bassa 2ª settimana → riduco carico sistemico",
    critical: [
      "STOP progressioni — salute prioritaria",
      "Deload anticipato per segni di overreaching"
    ]
  }
};

const MONTHLY_PHRASES = [
  "Proseguo Macrociclo attuale fino al deload programmato",
  "Anticipo deload di 1 settimana",
  "Riduzione aggressività del macrociclo",
  "Estensione macrociclo per stabilità metabolica"
];

function todayISO(){
  const d = new Date();
  const off = d.getTimezoneOffset();
  const local = new Date(d.getTime() - off*60000);
  return local.toISOString().slice(0,10);
}

function loadChecks(){
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
  catch { return []; }
}

function saveChecks(checks){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(checks));
}

function upsertCheck(check){
  const checks = loadChecks();
  const i = checks.findIndex(c => c.id === check.id);
  if (i >= 0) checks[i] = check;
  else checks.push(check);
  checks.sort((a,b)=> (a.data||"").localeCompare(b.data||""));
  saveChecks(checks);
  return i >= 0 ? "updated" : "created";
}

function lastWeeklyBefore(dateISO){
  const checks = loadChecks()
    .filter(c => c.tipo === "settimanale")
    .sort((a,b)=> (a.data||"").localeCompare(b.data||""));
  const idx = checks.findIndex(c => c.data === dateISO);
  if (idx > 0) return checks[idx-1];
  if (idx === -1) return checks.length ? checks[checks.length-1] : null;
  return null;
}

function lastWeekly(){
  const checks = loadChecks().filter(c => c.tipo === "settimanale");
  checks.sort((a,b)=> (a.data||"").localeCompare(b.data||""));
  return checks.length ? checks[checks.length-1] : null;
}

function classifyWeight(curr, prev){
  if (!Number.isFinite(curr) || !Number.isFinite(prev)) return { color:"yellow", delta:null, label:"Peso" };
  const delta = +(curr - prev).toFixed(1);
  if (delta <= 0.5) return { color:"green", delta, label:`Peso Δ ${delta} kg` };
  if (delta <= 1.0) return { color:"yellow", delta, label:`Peso Δ ${delta} kg` };
  return { color:"red", delta, label:`Peso Δ ${delta} kg` };
}

function classifyGly(curr){
  if (!Number.isFinite(curr)) return { color:"yellow", label:"Glicemia (manca)" };
  if (curr <= 100) return { color:"green", label:`Glicemia ${curr}` };
  if (curr <= 110) return { color:"yellow", label:`Glicemia ${curr}` };
  return { color:"red", label:`Glicemia ${curr}` };
}

function classifyEnergy(curr, prev){
  if (!Number.isFinite(curr)) return { color:"yellow", label:"Energia (manca)" };
  if (curr >= 6) return { color:"green", label:`Energia ${curr}` };
  if (curr >= 4) return { color:"yellow", label:`Energia ${curr}` };
  // curr <= 3
  if (Number.isFinite(prev) && prev <= 3) return { color:"red", label:`Energia ${curr} (2ª settimana)` };
  return { color:"yellow", label:`Energia ${curr} (1ª settimana)` };
}

function classifyNeu(trend){
  if (trend === "↑") return { color:"red", label:"Neuropatia ↑" };
  if (trend === "↓") return { color:"green", label:"Neuropatia ↓" };
  return { color:"green", label:"Neuropatia =" };
}

function classifyWaist(curr, prev){
  if (!Number.isFinite(curr)) return { color:"yellow", delta:null, label:"Vita (manca)" };
  if (!Number.isFinite(prev)) return { color:"green", delta:0, label:"Vita" };
  const delta = +(curr - prev).toFixed(1);
  if (delta <= 0) return { color:"green", delta, label:`Vita Δ ${delta} cm` };
  if (delta <= 1.0) return { color:"yellow", delta, label:`Vita Δ +${delta} cm` };
  return { color:"red", delta, label:`Vita Δ +${delta} cm` };
}

function globalStatus(classes){
  // priorità clinica
  if (classes.neuro.color === "red") return "red";
  if (classes.gly.color === "red") return "red";

  const yellows = [classes.weight, classes.energy, classes.waist]
    .filter(x => x.color === "yellow").length;

  if (yellows >= 2) return "yellow";
  return "green";
}

function allowedWeeklyPhrases(status, classes, prevCheck){
  if (status === "green") return WEEKLY_PHRASES.green;
  if (status === "yellow") return WEEKLY_PHRASES.yellow;

  // red: solo pertinenti
  const out = [];
  if (classes.neuro.color === "red") out.push(WEEKLY_PHRASES.red.neuro);
  if (classes.gly.color === "red") out.push(WEEKLY_PHRASES.red.gly);
  if (classes.energy.color === "red") out.push(WEEKLY_PHRASES.red.energy);

  const prevWasRed = prevCheck && prevCheck._statusGlobal === "red";
  if (prevWasRed) out.push(...WEEKLY_PHRASES.red.critical);

  return out.length ? out : WEEKLY_PHRASES.yellow;
}

function setBadge(el, color, text){
  el.classList.remove("green","yellow","red");
  el.classList.add(color);
  el.querySelector("span:last-child").textContent = text;
}

function numOrNull(v){
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

function readWeeklyInputs(){
  return {
    id: document.getElementById("wDate").value,
    tipo: "settimanale",
    data: document.getElementById("wDate").value,
    macrociclo: Number(document.getElementById("wMacro").value),

    pesoKg: numOrNull(document.getElementById("wWeight").value),
    glicemia: numOrNull(document.getElementById("wGly").value),
    energia: numOrNull(document.getElementById("wEnergy").value),
    neuropatia: document.getElementById("wNeuro").value,

    misure: {
      vita: numOrNull(document.getElementById("mWaist").value),
      fianchi: numOrNull(document.getElementById("mHip").value),
      petto: numOrNull(document.getElementById("mChest").value),
      braccio: numOrNull(document.getElementById("mArm").value),
      coscia: numOrNull(document.getElementById("mThigh").value),
    },

    nota: (document.getElementById("wNote").value || "").trim(),
    fraseFinale: document.getElementById("wPhrase").value
  };
}

function validateWeekly(check){
  if (!check.id) return "Manca la data.";
  if (!Number.isFinite(check.pesoKg)) return "Peso non valido.";
  if (!Number.isFinite(check.glicemia)) return "Glicemia non valida.";
  if (!Number.isFinite(check.energia) || check.energia < 1 || check.energia > 10) return "Energia non valida (1–10).";
  if (!check.misure || !Number.isFinite(check.misure.vita)) return "Vita (cm) è obbligatoria.";
  if (!["↓","=","↑"].includes(check.neuropatia)) return "Neuropatia non valida.";
  if ((check.nota||"").length > 240) return "Nota troppo lunga (max 240).";
  return null;
}

function renderWeeklyComputed(){
  const check = readWeeklyInputs();
  const prev = lastWeeklyBefore(check.data);

  const classes = {
    weight: classifyWeight(check.pesoKg, prev?.pesoKg),
    gly: classifyGly(check.glicemia),
    energy: classifyEnergy(check.energia, prev?.energia),
    waist: classifyWaist(check.misure?.vita, prev?.misure?.vita),
    neuro: classifyNeu(check.neuropatia)
  };

  const status = globalStatus(classes);

  setBadge(document.getElementById("bWeight"), classes.weight.color, classes.weight.label);
  setBadge(document.getElementById("bGly"), classes.gly.color, classes.gly.label);
  setBadge(document.getElementById("bEnergy"), classes.energy.color, classes.energy.label);
  setBadge(document.getElementById("bWaist"), classes.waist.color, classes.waist.label);
  setBadge(document.getElementById("bNeuro"), classes.neuro.color, classes.neuro.label);
  setBadge(document.getElementById("bGlobal"), status, `Stato ${status.toUpperCase()}`);

  // frasi consentite
  const phrases = allowedWeeklyPhrases(status, classes, prev);
  const sel = document.getElementById("wPhrase");
  const current = sel.value;
  sel.innerHTML = "";
  phrases.forEach(p => {
    const o = document.createElement("option");
    o.value = p; o.textContent = p;
    sel.appendChild(o);
  });
  // preserva se possibile
  if (phrases.includes(current)) sel.value = current;

  // aggiorna pill
  document.getElementById("pillMacro").textContent = `Macrociclo: ${check.macrociclo}`;

  return { classes, status, prev };
}

function setMsg(type, text){
  const el = document.getElementById("msg");
  if (!text){ el.innerHTML=""; return; }
  const cls = type === "ok" ? "ok" : (type === "err" ? "err" : "warning");
  el.innerHTML = `<div class="${cls}">${text}</div>`;
}

async function filesToBase64(fileList){
  const files = [...(fileList || [])];
  const out = [];
  for (const f of files){
    const b64 = await new Promise((res, rej)=>{
      const r = new FileReader();
      r.onload = ()=>res(r.result);
      r.onerror = rej;
      r.readAsDataURL(f);
    });
    out.push({ id: cryptoId(), src: b64 });
  }
  return out;
}

function cryptoId(){
  // id corto stabile
  return (crypto?.randomUUID ? crypto.randomUUID() : (Math.random().toString(36).slice(2)+Date.now().toString(36))).slice(0,18);
}

function createMonthlyCheck(){
  const date = document.getElementById("mDate").value;
  const macrociclo = Number(document.getElementById("mMacro").value);
  const note = (document.getElementById("mNote").value||"").trim();
  const phrase = document.getElementById("mPhrase").value;

  if (!date) return { error:"Manca la data mensile." };

  const all = loadChecks().filter(c => c.tipo === "settimanale").sort((a,b)=>a.data.localeCompare(b.data));
  const last4 = all.slice(-4);
  if (last4.length < 4) return { error:"Servono almeno 4 check settimanali per creare il mensile." };

  return {
    check: {
      id: date,
      tipo: "mensile",
      data: date,
      macrociclo,
      includeSettimane: last4.map(x=>x.id),
      nota: note,
      fraseFinale: phrase,
      foto: [] // aggiunte dopo
    }
  };
}

function renderMonthlyPhrases(){
  const sel = document.getElementById("mPhrase");
  sel.innerHTML = "";
  MONTHLY_PHRASES.forEach(p=>{
    const o=document.createElement("option");
    o.value=p; o.textContent=p;
    sel.appendChild(o);
  });
}

function renderList(){
  const list = document.getElementById("list");
  const ft = document.getElementById("filterType").value;
  const fm = document.getElementById("filterMacro").value;

  let checks = loadChecks().slice().sort((a,b)=> (b.data||"").localeCompare(a.data||""));

  if (ft !== "all") checks = checks.filter(c => c.tipo === ft);
  if (fm !== "all") checks = checks.filter(c => String(c.macrociclo) === fm);

  document.getElementById("stats").textContent =
    `Totale: ${checks.length}  •  Sett.: ${loadChecks().filter(c=>c.tipo==="settimanale").length}  •  Mens.: ${loadChecks().filter(c=>c.tipo==="mensile").length}`;

  list.innerHTML = "";
  checks.forEach(c=>{
    const status = c._statusGlobal || (c.tipo==="mensile" ? "green" : "yellow");
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="itemTop">
        <div class="itemTitle">${c.data} — ${c.tipo.toUpperCase()} (M${c.macrociclo})</div>
        <div class="tags">
          <div class="tag ${status}"><span class="dot"></span><span>${status.toUpperCase()}</span></div>
        </div>
      </div>
      <div class="muted" style="margin-top:6px">${c.fraseFinale || ""}</div>
      ${c.tipo==="settimanale" ? `
        <div class="tags" style="margin-top:8px">
          <div class="tag"><span class="dot"></span><span>Peso: ${c.pesoKg ?? "—"}</span></div>
          <div class="tag"><span class="dot"></span><span>Glicemia: ${c.glicemia ?? "—"}</span></div>
          <div class="tag"><span class="dot"></span><span>Energia: ${c.energia ?? "—"}</span></div>
          <div class="tag"><span class="dot"></span><span>Vita: ${c.misure?.vita ?? "—"}</span></div>
          <div class="tag"><span class="dot"></span><span>Neuro: ${c.neuropatia ?? "—"}</span></div>
        </div>
      ` : `
        <div class="muted" style="margin-top:8px">Include settimane: ${(c.includeSettimane||[]).join(", ")}</div>
      `}
      ${c.nota ? `<div class="noteSmall">${escapeHtml(c.nota)}</div>` : ``}
      ${c.foto && c.foto.length ? `<div class="thumbs">${c.foto.map(f=>`<img src="${f.src}" alt="foto">`).join("")}</div>` : ``}
      <div class="row" style="margin-top:10px;justify-content:flex-end">
        <button class="btn" data-del="${c.id}">Elimina</button>
        <button class="btn" data-load="${c.id}">Carica in form</button>
      </div>
    `;
    list.appendChild(div);
  });

  // handlers lista
  list.querySelectorAll("[data-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-del");
      const checks = loadChecks().filter(x=>x.id !== id);
      saveChecks(checks);
      setMsg("ok", `Eliminato check ${id}.`);
      renderList();
    });
  });

  list.querySelectorAll("[data-load]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-load");
      const c = loadChecks().find(x=>x.id === id);
      if (!c) return;
      if (c.tipo === "settimanale"){
        document.getElementById("wDate").value = c.data;
        document.getElementById("wMacro").value = String(c.macrociclo);
        document.getElementById("wWeight").value = c.pesoKg ?? "";
        document.getElementById("wGly").value = c.glicemia ?? "";
        document.getElementById("wEnergy").value = c.energia ?? "";
        document.getElementById("wNeuro").value = c.neuropatia ?? "=";
        document.getElementById("mWaist").value = c.misure?.vita ?? "";
        document.getElementById("mHip").value = c.misure?.fianchi ?? "";
        document.getElementById("mChest").value = c.misure?.petto ?? "";
        document.getElementById("mArm").value = c.misure?.braccio ?? "";
        document.getElementById("mThigh").value = c.misure?.coscia ?? "";
        document.getElementById("wNote").value = c.nota ?? "";
        renderWeeklyComputed();
        // prova a rimettere frase se ancora consentita
        const sel = document.getElementById("wPhrase");
        if ([...sel.options].some(o=>o.value===c.fraseFinale)) sel.value = c.fraseFinale;
        setMsg("ok", `Caricato check settimanale ${id} nel form.`);
      } else {
        document.getElementById("mDate").value = c.data;
        document.getElementById("mMacro").value = String(c.macrociclo);
        document.getElementById("mNote").value = c.nota ?? "";
        document.getElementById("mPhrase").value = c.fraseFinale ?? MONTHLY_PHRASES[0];
        setMsg("ok", `Caricato check mensile ${id} (solo campi mensili).`);
      }
    });
  });
}

function escapeHtml(str){
  return (str||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* ====== UI events ====== */
function wire(){
  document.getElementById("pillToday").textContent = `Oggi: ${todayISO()}`;

  // defaults date
  document.getElementById("wDate").value = todayISO();
  document.getElementById("mDate").value = todayISO();

  // monthly phrases
  renderMonthlyPhrases();

  // live compute
  ["wDate","wMacro","wWeight","wGly","wEnergy","wNeuro","mWaist","mHip","mChest","mArm","mThigh"].forEach(id=>{
    document.getElementById(id).addEventListener("input", ()=>{
      try { renderWeeklyComputed(); } catch {}
    });
    document.getElementById(id).addEventListener("change", ()=>{
      try { renderWeeklyComputed(); } catch {}
    });
  });

  document.getElementById("btnSaveWeekly").addEventListener("click", ()=>{
    const { classes, status } = renderWeeklyComputed();
    const check = readWeeklyInputs();

    const err = validateWeekly(check);
    if (err) return setMsg("err", err);

    // blocco frasi (consentite)
    const prev = lastWeeklyBefore(check.data);
    const allowed = allowedWeeklyPhrases(status, classes, prev);
    if (!allowed.includes(check.fraseFinale)) {
      return setMsg("err","Frase finale non consentita per lo stato attuale.");
    }

    // salva anche stato e classi (per storico e persistente)
    check._statusGlobal = status;
    check._classes = classes;
    check.createdAt = check.createdAt || new Date().toISOString();
    check.updatedAt = new Date().toISOString();

    const result = upsertCheck(check);
    setMsg("ok", result === "created" ? "Check settimanale salvato." : "Check settimanale aggiornato.");
    renderList();
  });

  document.getElementById("btnUpdateWeekly").addEventListener("click", ()=>{
    document.getElementById("btnSaveWeekly").click();
  });

  document.getElementById("btnSaveMonthly").addEventListener("click", async ()=>{
    const make = createMonthlyCheck();
    if (make.error) return setMsg("err", make.error);

    const check = make.check;

    if ((check.nota||"").length > 240) return setMsg("err","Nota mensile troppo lunga (max 240).");
    if (!MONTHLY_PHRASES.includes(check.fraseFinale)) return setMsg("err","Frase mensile non valida.");

    // foto
    const photosEl = document.getElementById("mPhotos");
    const files = photosEl.files;
    if (files && files.length){
      const photos = await filesToBase64(files);
      check.foto = photos.slice(0, 6); // limite sicurezza
    }

    check._statusGlobal = "green";
    check.createdAt = check.createdAt || new Date().toISOString();
    check.updatedAt = new Date().toISOString();

    const result = upsertCheck(check);
    setMsg("ok", result === "created" ? "Check mensile salvato." : "Check mensile aggiornato.");
    photosEl.value = "";
    renderList();
  });

  document.getElementById("btnRefresh").addEventListener("click", ()=>renderList());
  document.getElementById("filterType").addEventListener("change", ()=>renderList());
  document.getElementById("filterMacro").addEventListener("change", ()=>renderList());

  document.getElementById("btnFillDemo").addEventListener("click", ()=>{
    const lw = lastWeekly();
    const baseW = lw?.pesoKg ?? 81;
    const baseWaist = lw?.misure?.vita ?? 86;
    document.getElementById("wWeight").value = (baseW + 0.2).toFixed(1);
    document.getElementById("wGly").value = 95;
    document.getElementById("wEnergy").value = 6;
    document.getElementById("wNeuro").value = "=";
    document.getElementById("mWaist").value = (baseWaist - 0.2).toFixed(1);
    document.getElementById("mHip").value = 94;
    document.getElementById("mChest").value = 108;
    document.getElementById("mArm").value = 35;
    document.getElementById("mThigh").value = 54;
    document.getElementById("wNote").value = "Demo";
    renderWeeklyComputed();
    setMsg("ok","Demo compilata.");
  });

  document.getElementById("btnReset").addEventListener("click", ()=>{
    const ok = confirm("Sicuro? Cancella SOLO i check salvati sul dispositivo.");
    if (!ok) return;
    localStorage.removeItem(STORAGE_KEY);
    setMsg("ok","Check cancellati.");
    renderList();
    renderWeeklyComputed();
  });

  document.getElementById("btnExport").addEventListener("click", ()=>{
    const data = {
      exportedAt: new Date().toISOString(),
      checks: loadChecks()
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `MASTER2026_CHECKS_${todayISO()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    setMsg("ok","Export scaricato.");
  });

  document.getElementById("btnImport").addEventListener("click", ()=>{
    const input = document.createElement("input");
    input.type="file"; input.accept="application/json";
    input.onchange = async ()=>{
      const f = input.files?.[0];
      if (!f) return;
      const txt = await f.text();
      let obj;
      try{ obj = JSON.parse(txt); } catch { return setMsg("err","File JSON non valido."); }
      if (!obj || !Array.isArray(obj.checks)) return setMsg("err","JSON non valido: manca 'checks'.");
      const existing = loadChecks();
      // merge by id
      const map = new Map(existing.map(c=>[c.id,c]));
      obj.checks.forEach(c=>{
        if (c && c.id) map.set(c.id, c);
      });
      const merged = [...map.values()].sort((a,b)=> (a.data||"").localeCompare(b.data||""));
      saveChecks(merged);
      setMsg("ok","Import completato (merge).");
      renderList();
    };
    input.click();
  });

  // initial compute + list
  renderWeeklyComputed();
  renderList();
}

/* ====== PWA register (se hai già sw, ok) ====== */
if ("serviceWorker" in navigator){
  window.addEventListener("load", async ()=>{
    try { await navigator.serviceWorker.register("./sw.js"); } catch {}
  });
}

wire();
</script>
</body>
</html>
